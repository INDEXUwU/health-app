<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール登録｜健康管理アプリ</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
    <!-- Shared Style -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            width: 100%;
            max-width: 500px;
            /* Slightly wider */
            text-align: center;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="auth-container">
        <div class="card auth-card fade-in">
            <div class="mb-2">
                <h1>プロフィール設定</h1>
                <p class="text-muted">あなたに合ったアドバイスのために<br>情報を入力してください</p>
            </div>

            <form id="profileForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="age">年齢</label>
                        <input type="number" id="age" placeholder="25" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="gender">性別</label>
                        <select id="gender" required>
                            <option value="">選択</option>
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="height">身長 (cm)</label>
                        <input type="number" id="height" step="0.1" placeholder="170.5" required>
                    </div>
                    <div class="form-group">
                        <label for="weight">現在の体重 (kg)</label>
                        <input type="number" id="weight" step="0.1" placeholder="60.0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="target_weight" style="color: var(--primary-dark);">目標体重 (kg)</label>
                    <input type="number" id="target_weight" step="0.1" placeholder="58.0" required
                        style="background: #e8f5e9; border-color: var(--primary);">
                </div>

                <button type="submit" class="btn btn-block mt-2">設定を保存して開始</button>
            </form>
        </div>
    </div>

    <!-- Shared Components -->
    <script src="js/components.js"></script>
    <script>
        // Check if coming from register
        const login_id = localStorage.getItem("login_id");
        if (!login_id) {
            window.location.href = "login.html";
        }

        document.getElementById("profileForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const age = document.getElementById("age").value;
            const gender = document.getElementById("gender").value;
            const height = document.getElementById("height").value;
            const weight = document.getElementById("weight").value;
            const target_weight = document.getElementById("target_weight").value;

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = "保存中...";

            try {
                // 1. Save Profile
                const res = await fetch("/api/user-info", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        login_id, age, gender, height, weight, target_weight
                    })
                });

                if (!res.ok) throw new Error("Profile update failed");

                // 2. Also register initial weight to weight_records
                await fetch("/api/weight", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ login_id, weight })
                });

                Toast.show("設定が完了しました！", "success");

                setTimeout(() => {
                    window.location.href = "home.html";
                }, 1000);

            } catch (err) {
                console.error(err);
                Toast.show("エラーが発生しました", "error");
                submitBtn.disabled = false;
                submitBtn.textContent = "設定を保存して開始";
            }
        });
    </script>
</body>

</html>