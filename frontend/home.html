<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ›ãƒ¼ãƒ ï½œå¥åº·ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
    <!-- Shared Style -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js -->
    <script src="js/chart.umd.min.js" defer></script>
    <style>
        /* Dashboard Bento Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding-bottom: 20px;
        }

        /* PC Layout (3 Columns) */
        @media (min-width: 900px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
                /* grid-template-rows: auto auto; -> Implicit is fine */
                align-items: start;
            }

            .grid-item-advice {
                grid-column: span 2;
                grid-row: span 1;
            }

            .grid-item-schedule {
                grid-column: span 1;
                grid-row: span 1;
                height: 100%;
                /* Match height with advice card if possible, or just be auto */
                display: flex;
                flex-direction: column;
            }

            .grid-item-weight {
                grid-column: span 2;
            }

            .grid-item-calorie {
                grid-column: span 1;
            }
        }

        .advice-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
            border: 2px solid #e8f5e9;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: var(--radius-sm);
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .stat-val {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-dark);
        }

        [data-theme="dark"] .stat-label {
            color: #CCCCCC;
        }

        [data-theme="dark"] .stat-val {
            color: #81C784;
        }

        [data-theme="dark"] .advice-card {
            background: rgba(50, 50, 70, 0.6);
            border-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .stat-box {
            background: rgba(40, 40, 60, 0.5);
        }

        .weight-meter-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .weight-meter-labels {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .weight-remaining {
            font-weight: bold;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .progress-wrapper {
            position: relative;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            width: 0;
            border-radius: 12px;
            transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
        }

        /* Shining effect */
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.3) 50%,
                    rgba(255, 255, 255, 0) 100%);
            transform: translateX(-100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        .progress-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        [data-theme="dark"] .weight-meter-container {
            background: rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .progress-wrapper {
            background: #444;
        }
    </style>
</head>

<body>
    <!-- Header rendered by js/components.js -->

    <div class="container fade-in">
        <div class="mb-2">
            <h1><span id="userName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼</h1>
            <p class="text-muted">ä»Šæ—¥ã‚‚å¥åº·çš„ãªä¸€æ—¥ã‚’éã”ã—ã¾ã—ã‚‡ã†</p>
        </div>

        <div class="dashboard-grid">
            <!-- 1. Advice & Progress (Main Feature) -->
            <div class="card grid-item-advice advice-card">
                <h2>ğŸŒ± ä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
                <div id="loadingAdvice">AI ãŒãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</div>

                <div id="adviceContent" style="display:none;">
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">ä»Šæ—¥ã®æ‘‚å–</div>
                            <div class="stat-val" id="valIntake">-- kcal</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ä»Šæ—¥ã®æ¶ˆè²»</div>
                            <div class="stat-val" id="valBurn">-- kcal</div>
                        </div>
                    </div>

                    <div class="weight-meter-container">
                        <div class="weight-meter-labels">
                            <span class="text-muted" style="font-size: 0.9em;">ç›®æ¨™ã¾ã§</span>
                            <span class="weight-remaining" id="weightDiffText">-- kg</span>
                        </div>
                        <!-- Meter -->
                        <div class="progress-wrapper">
                            <div class="progress-fill" id="progressBar"></div>
                        </div>
                        <div class="progress-footer">
                            <span id="currentWeightText">ç¾åœ¨: -- kg</span>
                            <span id="targetWeightText">ç›®æ¨™: -- kg</span>
                        </div>
                    </div>

                    <div class="mt-2" style="background: rgba(255,255,255,0.3); padding:15px; border-radius:8px;">
                        <ul id="adviceList" class="advice-list">
                            <!-- AI Advice Text -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 2. Next Schedule & Tools -->
            <div class="card grid-item-schedule" id="nextScheduleCard" style="border-left: 5px solid var(--primary);">
                <h3>ğŸ“… æ¬¡ã®é‹å‹•äºˆå®š</h3>
                <div id="nextScheduleContent">
                    <p class="text-muted" style="font-size:0.9rem;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
                <div style="margin-top:auto; padding-top: 8px; text-align: right;">
                    <a href="schedule.html" style="font-size:0.8rem; display:inline-block; margin-top:10px;">äºˆå®šã‚’ç®¡ç†
                        &rarr;</a>
                </div>

                <!-- Tools Section -->
                <div class="tool-container">
                    <div class="tool-tabs">
                        <div class="tool-tab active" onclick="Tool.switch('timer')">ã‚¿ã‚¤ãƒãƒ¼</div>
                        <div class="tool-tab" onclick="Tool.switch('stopwatch')">ã‚¦ã‚©ãƒƒãƒ</div>
                    </div>

                    <!-- Timer -->
                    <div id="tool-timer" class="tool-content active">
                        <div class="timer-inputs" id="timerSetup">
                            <input type="number" id="timerMin" class="timer-input" value="3" min="0" max="99"> åˆ†
                            <input type="number" id="timerSec" class="timer-input" value="00" min="0" max="59"> ç§’
                        </div>
                        <div class="timer-display" id="timerDisplay">03:00</div>
                        <div class="timer-controls">
                            <button class="btn btn-circle" onclick="Tool.Timer.toggle()" id="timerBtnPlay">â–¶</button>
                            <button class="btn btn-circle btn-secondary" onclick="Tool.Timer.reset()">â†º</button>
                        </div>
                    </div>

                    <!-- Stopwatch -->
                    <div id="tool-stopwatch" class="tool-content">
                        <div class="timer-display" id="swDisplay">00:00.00</div>
                        <div class="timer-controls">
                            <button class="btn btn-circle" onclick="Tool.Stopwatch.toggle()" id="swBtnPlay">â–¶</button>
                            <button class="btn btn-circle btn-secondary" onclick="Tool.Stopwatch.reset()">â†º</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Weight Chart (Trend) -->
            <div class="card grid-item-weight">
                <h3>ä½“é‡ã®æ¨ç§»</h3>
                <div style="position:relative; height:200px; width:100%;">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <!-- 4. Calorie Balance Chart (Detail) -->
            <div class="card grid-item-calorie">
                <h3>ä»Šæ—¥ã®æ‘‚å–ãƒ»æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼</h3>
                <div style="position:relative; height:200px; width:100%;">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Components -->
        <script src="js/components.js"></script>
        <script>
            // Init header
            renderHeader("ãƒ›ãƒ¼ãƒ ");

            // Set User Name
            const userName = localStorage.getItem("userName") || "ã‚²ã‚¹ãƒˆ";
            document.getElementById("userName").textContent = userName;

            let weightChart = null;
            let balanceChart = null;

            // Global Data Cache
            let cachedDashboardData = null;
            let cachedWeightData = null;

            // Theme check for Chart.js
            const getChartTextColor = () => {
                return document.documentElement.getAttribute('data-theme') === 'dark' ? '#eee' : '#666';
            };

            const getChartGridColor = () => {
                return document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            };

            // Main entry point
            async function loadDashboard() {
                const login_id = localStorage.getItem("login_id");
                if (!login_id) return;

                try {
                    // 1. Fetch Data
                    const [adviceRes, weightRes, scheduleRes] = await Promise.all([
                        fetch(`/api/advice/${login_id}`),
                        fetch(`/api/weights/${login_id}`),
                        fetch(`/api/scheduled-exercises/${login_id}`)
                    ]);

                    cachedDashboardData = await adviceRes.json();
                    cachedWeightData = await weightRes.json();
                    const scheduleData = await scheduleRes.json();

                    if (!cachedDashboardData.success) throw new Error("Failed to load advice");

                    // 2. Render DOM Elements (Advice, Stats, Progress)
                    renderDomElements(cachedDashboardData);

                    // Render Next Schedule
                    renderNextSchedule(scheduleData);

                    // 3. Render Charts
                    renderAllCharts();

                } catch (err) {
                    console.error(err);
                    document.getElementById("loadingAdvice").textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
                }
            }

            function renderNextSchedule(list) {
                if (!list || list.length === 0) return;

                // Filter for future only (simple client-side filter)
                const now = new Date();
                const future = list.filter(item => new Date(item.scheduled_datetime) > now);

                if (future.length > 0) {
                    const next = future[0]; // Already sorted by backend ASC
                    const d = new Date(next.scheduled_datetime);
                    const dateStr = `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${(d.getMinutes() < 10 ? '0' : '') + d.getMinutes()}`;

                    const html = `
                        <div style="padding: 15px; background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">
                            <div style="font-weight: bold; color: var(--primary-dark); font-size: 1.1rem; margin-bottom: 5px;">${next.exercise_name}</div>
                            <div class="text-muted" style="font-size: 0.95rem; display: flex; align-items: center; gap: 5px;">
                                <span>ğŸ•’</span> ${dateStr}
                            </div>
                            ${next.notes ? `<div style="font-size: 0.85rem; margin-top: 8px; color: #666; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 5px;">${next.notes}</div>` : ''}
                        </div>
                    `;
                    document.getElementById("nextScheduleContent").innerHTML = html;
                    // document.getElementById("nextScheduleCard").style.display = "block"; // Always shown now
                }
            }

            function renderDomElements(data) {
                // Update UI
                document.getElementById("loadingAdvice").style.display = "none";
                document.getElementById("adviceContent").style.display = "block";

                // Stats
                document.getElementById("valIntake").textContent = `${data.today_intake} kcal`;
                document.getElementById("valBurn").textContent = `${data.today_burn} kcal`;

                // Progress Bar
                if (data.progress) {
                    const { current_weight, target_weight } = data.progress;
                    document.getElementById("currentWeightText").textContent = `ç¾åœ¨: ${current_weight} kg`;
                    document.getElementById("targetWeightText").textContent = `ç›®æ¨™: ${target_weight} kg`;

                    const diff = current_weight - target_weight;
                    const diffText = diff > 0 ? `ã‚ã¨ ${diff.toFixed(1)}kg` : "ç›®æ¨™é”æˆï¼";
                    document.getElementById("weightDiffText").textContent = diffText;

                    if (diff <= 0) {
                        document.getElementById("weightDiffText").style.color = "var(--success)";
                    } else {
                        document.getElementById("weightDiffText").style.color = "";
                    }

                    // Linear map: 10kg -> 0%, 0kg -> 100%
                    let percent = diff <= 0 ? 100 : Math.max(5, Math.min(100, 100 - (diff * 10)));

                    setTimeout(() => {
                        const bar = document.getElementById("progressBar");
                        if (bar) {
                            bar.style.width = `${percent}%`;
                            if (percent >= 100) bar.style.background = "var(--success)";
                            else if (percent < 20) bar.style.background = "var(--warning)";
                        }
                    }, 100);
                }

                // Advice list
                const list = document.getElementById("adviceList");
                list.innerHTML = "";
                const adviceArr = data.advice_text || data.advice;
                if (adviceArr && Array.isArray(adviceArr)) {
                    adviceArr.forEach(text => {
                        const li = document.createElement("li");
                        li.textContent = `ğŸ’¡ ${text}`;
                        li.style.marginBottom = "8px";
                        list.appendChild(li);
                    });
                }
            }

            function renderAllCharts() {
                if (cachedDashboardData) {
                    renderBalanceChart(cachedDashboardData.today_intake, cachedDashboardData.today_burn);
                }
                if (cachedWeightData) {
                    renderWeightChart(cachedWeightData);
                }
            }

            function renderBalanceChart(intake, burn) {
                const ctx = document.getElementById("balanceChart").getContext("2d");
                if (balanceChart) balanceChart.destroy();

                const textColor = getChartTextColor();

                balanceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [`æ‘‚å–: ${intake} kcal`, `æ¶ˆè²»: ${burn} kcal`],
                        datasets: [{
                            data: [intake, burn],
                            backgroundColor: ['#FF7043', '#42A5F5'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: textColor }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return ` ${context.raw} kcal`;
                                    }
                                }
                            }
                        },
                        cutout: '60%',
                    }
                });
            }

            function renderWeightChart(weightData) {
                const ctx = document.getElementById("weightChart").getContext("2d");
                if (weightChart) weightChart.destroy();

                const recent = weightData.slice(-14);
                const labels = recent.map(d => new Date(d.record_date).toLocaleDateString());
                const data = recent.map(d => d.weight);

                const textColor = getChartTextColor();
                const gridColor = getChartGridColor();

                weightChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ä½“é‡ (kg)',
                            data: data,
                            borderColor: '#66BB6A',
                            backgroundColor: 'rgba(102, 187, 106, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#66BB6A'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor, maxRotation: 45, minRotation: 45 },
                                grid: { color: gridColor, drawBorder: false }
                            },
                            y: {
                                ticks: { color: textColor },
                                grid: { color: gridColor, borderDash: [5, 5] },
                                suggestedMin: Math.min(...data) - 1.0,
                                suggestedMax: Math.max(...data) + 1.0
                            }
                        }
                    }
                });
            }

            // Re-render ONLY charts when theme changes (prevent data refetch)
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === "attributes" && mutation.attributeName === "data-theme") {
                        renderAllCharts();
                    }
                });
            });
            observer.observe(document.documentElement, { attributes: true });

            // Tool Logic
            const Tool = {
                switch: (type) => {
                    document.querySelectorAll('.tool-tab').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.tool-content').forEach(el => el.classList.remove('active'));

                    if (type === 'timer') {
                        document.querySelectorAll('.tool-tab')[0].classList.add('active');
                        document.getElementById('tool-timer').classList.add('active');
                    } else {
                        document.querySelectorAll('.tool-tab')[1].classList.add('active');
                        document.getElementById('tool-stopwatch').classList.add('active');
                    }
                },

                Timer: {
                    interval: null,
                    timeLeft: 180, // seconds
                    isRunning: false,

                    toggle: () => {
                        if (Tool.Timer.isRunning) Tool.Timer.pause();
                        else Tool.Timer.start();
                    },

                    start: () => {
                        if (Tool.Timer.isRunning) return;

                        // If starting from setup, parse inputs
                        if (Tool.Timer.timeLeft === null) {
                            const m = parseInt(document.getElementById('timerMin').value) || 0;
                            const s = parseInt(document.getElementById('timerSec').value) || 0;
                            Tool.Timer.timeLeft = m * 60 + s;
                        }

                        if (Tool.Timer.timeLeft <= 0) return;

                        Tool.Timer.isRunning = true;
                        document.getElementById('timerBtnPlay').textContent = 'â¸';
                        document.getElementById('timerSetup').style.display = 'none'; // Hide setup while running

                        const endTime = Date.now() + (Tool.Timer.timeLeft * 1000);

                        Tool.Timer.interval = setInterval(() => {
                            const now = Date.now();
                            const diff = Math.ceil((endTime - now) / 1000);

                            if (diff <= 0) {
                                Tool.Timer.finish();
                            } else {
                                Tool.Timer.timeLeft = diff;
                                Tool.Timer.updateDisplay();
                            }
                        }, 100);
                    },

                    pause: () => {
                        Tool.Timer.isRunning = false;
                        document.getElementById('timerBtnPlay').textContent = 'â–¶';
                        clearInterval(Tool.Timer.interval);
                        // timeLeft is already updated in the loop
                    },

                    reset: () => {
                        Tool.Timer.pause();
                        Tool.Timer.timeLeft = null; // Signal to re-read inputs
                        document.getElementById('timerSetup').style.display = 'flex';

                        // Parse inputs for display
                        const m = parseInt(document.getElementById('timerMin').value) || 0;
                        const s = parseInt(document.getElementById('timerSec').value) || 0;
                        document.getElementById('timerDisplay').textContent =
                            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    },

                    finish: () => {
                        Tool.Timer.pause();
                        Tool.Timer.timeLeft = 0;
                        Tool.Timer.updateDisplay();

                        // Sound or Alert
                        Modal.alert("ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†ï¼", "æ™‚é–“ã§ã™");
                        Tool.Timer.reset();
                    },

                    updateDisplay: () => {
                        const m = Math.floor(Tool.Timer.timeLeft / 60);
                        const s = Tool.Timer.timeLeft % 60;
                        document.getElementById('timerDisplay').textContent =
                            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    }
                },

                Stopwatch: {
                    interval: null,
                    startTime: null,
                    elapsed: 0,
                    isRunning: false,

                    toggle: () => {
                        if (Tool.Stopwatch.isRunning) Tool.Stopwatch.pause();
                        else Tool.Stopwatch.start();
                    },

                    start: () => {
                        if (Tool.Stopwatch.isRunning) return;
                        Tool.Stopwatch.isRunning = true;
                        document.getElementById('swBtnPlay').textContent = 'â¸';

                        Tool.Stopwatch.startTime = Date.now() - Tool.Stopwatch.elapsed;

                        Tool.Stopwatch.interval = setInterval(() => {
                            Tool.Stopwatch.elapsed = Date.now() - Tool.Stopwatch.startTime;
                            Tool.Stopwatch.updateDisplay();
                        }, 50); // 20fps for display
                    },

                    pause: () => {
                        Tool.Stopwatch.isRunning = false;
                        document.getElementById('swBtnPlay').textContent = 'â–¶';
                        clearInterval(Tool.Stopwatch.interval);
                    },

                    reset: () => {
                        Tool.Stopwatch.pause();
                        Tool.Stopwatch.elapsed = 0;
                        Tool.Stopwatch.updateDisplay();
                    },

                    updateDisplay: () => {
                        const ms = Tool.Stopwatch.elapsed % 1000;
                        const s = Math.floor(Tool.Stopwatch.elapsed / 1000) % 60;
                        const m = Math.floor(Tool.Stopwatch.elapsed / 60000);

                        document.getElementById('swDisplay').textContent =
                            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${Math.floor(ms / 10).toString().padStart(2, '0')}`;
                    }
                }
            };

            // Initial timer set
            Tool.Timer.reset();

            // Initial Load
            loadDashboard();
        </script>
</body>

</html>