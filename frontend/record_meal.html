<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿäº‹è¨˜éŒ² | å¥åº·ç®¡çE‚¢ãƒ—ãƒª</title>

    <!-- Chart.js èª­ã¿è¾¼ã¿ -->
    <script src="js/chart.umd.min.js" defer=""></script>

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #f6d365, #fda085);
            margin: 0;
            padding: 0;
            text-align: center;
        }

        header {
            background-color: #fff;
            padding: 20px;
            font-size: 22px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        main {
            margin-top: 40px;
        }

        input {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            background-color: #ff7b54;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #ff5722;
        }

        .back-btn {
            margin-top: 20px;
            background-color: #ffa726;
            font-size: 16px;
            padding: 12px 20px;
        }

        .back-btn:hover {
            background-color: #fb8c00;
        }

        table {
            margin: 40px auto;
            border-collapse: collapse;
            width: 80%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
        }

        th {
            background: #ff7b54;
            color: white;
        }

        .chart-wrap {
            margin: 40px auto;
            width: 85%;
            max-width: 700px;
        }

        /* â–¼ è‡ªå‹•ã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—ãEèª¬æ˜æ–‡ */
        .auto-info {
            font-size: 14px;
            color: #fff;
            margin-top: -10px;
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <header>é£Ÿäº‹è¨˜éŒ²</header>

    <main>
        <h2>ä»Šæ—¥ã®é£Ÿäº‹ã‚’è¨˜éŒ²</h2>

        <input type="text" id="meal_name" placeholder="æ–™ç†åE oninput="autoCalcCalories()">
        <input type="number" id="calories" placeholder="ã‚«ãƒ­ãƒªãƒ¼ (kcal)">
        <div class="auto-info">ğŸ½EEæ–™ç†åã‚’å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ã§ã‚«ãƒ­ãƒªãƒ¼ã‚’æ¨å®šã—ã¾ãE/div>

        <button onclick="saveMeal()">ç™»éŒ²</button>

        <h3>æœ€è¿‘ãEé£Ÿäº‹è¨˜éŒ²</h3>
        <table id="mealTable">
            <tbody>
                <tr>
                    <th>æ—¥ä»E/th>
                    <th>æ–™ç†åE/th>
                    <th>ã‚«ãƒ­ãƒªãƒ¼</th>
                </tr>
            </tbody>
        </table>

        <div class="chart-wrap">
            <canvas id="mealChart"></canvas>
        </div>

        <button class="back-btn" onclick="location.href='home.html'">â†Eãƒ›ãEãƒ ã¸æˆ»ã‚E/button>

        <br><br>

    </main>

    <script>
        const login_id = localStorage.getItem("login_id");
        let chart = null;

        // â–¼ æ—¥æœ¬æ™‚é–“ã«å¤‰æ›ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒE
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString("ja-JP", {
                timeZone: "Asia/Tokyo",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        /* ===========================================
           ğŸ½EEè‡ªå‹•ã‚«ãƒ­ãƒªãƒ¼æ¨å®šãƒ‡ãƒ¼ã‚¿Eˆç°¡æ˜“è¾æ›¸EE
        =========================================== */
        const calorieDB = {
            "ã‚«ãƒ¬ãƒ¼": 700,
            "ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹": 850,
            "ãƒ©ãƒ¼ãƒ¡ãƒ³": 550,
            "å‘³å™Œãƒ©ãƒ¼ãƒ¡ãƒ³": 600,
            "é†¤æ²¹ãƒ©ãƒ¼ãƒ¡ãƒ³": 480,
            "ãƒãƒ£ãƒ¼ãƒãƒ³": 650,
            "ã‚µãƒ©ãƒ€": 120,
            "ã‚µãƒ³ãƒ‰ã‚¤ãƒEƒ": 300,
            "ç‰›ä¸¼": 900,
            "å¯¿å¸": 450,
            "å¤©ã·ã‚E: 500,
            "ã‚ªãƒ ãƒ©ã‚¤ã‚¹": 700,
            "ãƒ‘ã‚¹ã‚¿": 600,
            "ãƒ”ã‚¶": 700,
            "ãƒˆãƒ³ã‚«ãƒE: 800,
            "ã‹ã‚‰ã‚ã’": 450
        };

        /* ===========================================
           ğŸ³ æ–™ç†åEâ†Eã‚«ãƒ­ãƒªãƒ¼è‡ªå‹•åEåŠ›æ©ŸèE
        =========================================== */
        function autoCalcCalories() {
            const name = document.getElementById("meal_name").value.trim();

            if (name === "") return;

            // å®ŒåEä¸€è‡´ â†Eç™»éŒ²ã‚«ãƒ­ãƒªãƒ¼
            if (calorieDB[name]) {
                document.getElementById("calories").value = calorieDB[name];
                return;
            }

            // éƒ¨åˆE¸€è‡´Eˆä¾‹ï¼šå‘³å™Œãƒ©ãƒ¼ãƒ¡ãƒ³ â†Eãƒ©ãƒ¼ãƒ¡ãƒ³EE
            for (const key in calorieDB) {
                if (name.includes(key)) {
                    document.getElementById("calories").value = calorieDB[key];
                    return;
                }
            }

            // ä½•ã‚‚ä¸€è‡´ã—ãªãEâ†Eå¹³åE€¤
            document.getElementById("calories").value = 300;
        }

        // é£Ÿäº‹ãEä¿å­E
        async function saveMeal() {
            const meal_name = document.getElementById("meal_name").value;
            const calories = document.getElementById("calories").value;

            const res = await fetch("/api/meal", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ login_id, meal_name, calories })
            });

            const data = await res.json();
            alert(data.message);

            document.getElementById("meal_name").value = "";
            document.getElementById("calories").value = "";

            loadMeals();
        }

        // é£Ÿäº‹ä¸€è¦§è¡¨ç¤º
        async function loadMeals() {
            const res = await fetch(`/api/meals/${login_id}`);
            const meals = await res.json();

            const table = document.getElementById("mealTable");
            table.innerHTML = "<tr><th>æ—¥ä»E/th><th>æ–™ç†åE/th><th>ã‚«ãƒ­ãƒªãƒ¼</th></tr>";

            meals.forEach(m => {
                table.innerHTML += `
                <tr>
                    <td>${formatDateTime(m.meal_datetime)}</td>
                    <td>${m.meal_name}</td>
                    <td>${m.calories} kcal</td>
                </tr>`;
            });

            loadDailyChart();
        }

        // â–¼ æ—¥åˆ¥ã‚«ãƒ­ãƒªãƒ¼é›E¨EPI
        async function loadDailyChart() {
            const res = await fetch(`/api/meals/daily/${login_id}`);
            const data = await res.json();

            const labels = data.map(d => d.meal_date);
            const calories = data.map(d => d.total_calories);

            drawChart(labels, calories);
        }

        // ã‚°ãƒ©ãƒ•æç”»
        function drawChart(labels, calories) {
            const ctx = document.getElementById("mealChart").getContext("2d");

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "æ—¥åˆ¥ã‚«ãƒ­ãƒªãƒ¼åˆè¨E(kcal)",
                        data: calories,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        loadMeals();
    </script>


</body>

</html>
