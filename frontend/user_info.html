<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール編集｜健康管理アプリ</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
    <!-- Shared Style -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header -->
    <script src="js/components.js"></script>
    <script>renderHeader("設定");</script>

    <div class="container fade-in">
        <div class="mb-2">
            <h1>プロフィール編集</h1>
            <p class="text-muted">プロフィール情報を更新します</p>
        </div>

        <div class="card" style="max-width:600px; margin:0 auto;">
            <form id="userForm">
                <div class="form-group">
                    <label for="name">お名前</label>
                    <input type="text" id="name" required>
                </div>

                <div style="display:flex; gap:15px;">
                    <div class="form-group" style="flex:1;">
                        <label for="age">年齢</label>
                        <input type="number" id="age" required min="5" max="120">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="gender">性別</label>
                        <select id="gender" required>
                            <option value="">選択</option>
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; gap:15px;">
                    <div class="form-group" style="flex:1;">
                        <label for="height">身長 (cm)</label>
                        <input type="number" id="height" step="0.1" required>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="weight">体重 (kg)</label>
                        <input type="number" id="weight" step="0.1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="target_weight" style="color:var(--primary);">目標体重 (kg)</label>
                    <input type="number" id="target_weight" step="0.1" required>
                </div>

                <button type="button" onclick="saveUserInfo()" class="btn btn-block mt-2">
                    変更を保存する
                </button>
            </form>
        </div>
    </div>

    <!-- Logic -->
    <script>
        const login_id = localStorage.getItem("login_id");

        // Load Data
        async function loadUserInfo() {
            try {
                const res = await fetch(`/api/user-info/${login_id}`);
                const data = await res.json();

                // Map values
                // Note: The API returns English keys, but in previous file gender values were Japanese "男性"/"女性"
                // Checking previous code: select used "男性" value. 
                // Let's standardise on "male"/"female" values in select, but we need to see what DB has.
                // Assuming DB has whatever string was sent.
                // If the previous code sent "男性", then we need to handle that.
                // Modern practice -> standardise, but let's just assume simple mapping or loose equality.

                document.getElementById("name").value = data.name || "";
                document.getElementById("age").value = data.age || "";

                // Handle gender mapping if legacy data exists
                let g = data.gender;
                if (g === "男性") g = "male";
                if (g === "女性") g = "female";
                document.getElementById("gender").value = g || "";

                document.getElementById("height").value = data.height || "";
                document.getElementById("weight").value = data.weight || "";
                document.getElementById("target_weight").value = data.target_weight || "";
            } catch (e) {
                console.error(e);
                Toast.show("データの読み込みに失敗しました", "error");
            }
        }

        // Save Data
        async function saveUserInfo() {
            const name = document.getElementById("name").value.trim();
            const age = document.getElementById("age").value;
            const gender = document.getElementById("gender").value;
            const height = document.getElementById("height").value;
            const weight = document.getElementById("weight").value;
            const target_weight = document.getElementById("target_weight").value;

            // Simple validation
            if (!name) return Toast.show("名前を入力してください", "error");

            const btn = document.querySelector('button');
            btn.disabled = true;
            btn.textContent = "保存中...";

            try {
                const res = await fetch("/api/user-info", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        login_id, name, age, gender, height, weight, target_weight
                    })
                });

                if (res.ok) {
                    Toast.show("プロフィールを更新しました", "success");
                    localStorage.setItem("userName", name); // Update local cache
                    setTimeout(() => location.href = "home.html", 800);
                } else {
                    const d = await res.json();
                    Toast.show(d.message || "エラーが発生しました", "error");
                    btn.disabled = false;
                    btn.textContent = "変更を保存する";
                }
            } catch (err) {
                console.error(err);
                Toast.show("サーバーエラー", "error");
                btn.disabled = false;
                btn.textContent = "変更を保存する";
            }
        }

        loadUserInfo();
    </script>
</body>

</html>