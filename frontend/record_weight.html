<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>菴馴㍾險倬鹸 | 蛛･蠎ｷ邂｡逅・い繝励Μ</title>

    <script src="js/chart.umd.min.js" defer></script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(to bottom right, #a8e6cf, #dcedc1);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        header {
            background-color: #4caf50;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
        }

        .container {
            max-width: 500px;
            margin: 25px auto;
            background-color: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        label {
            color: #388e3c;
            font-size: 14px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin: 10px 0 20px;
            font-size: 15px;
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background-color: #4caf50;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            border: none;
        }

        .save-btn:hover {
            background-color: #43a047;
        }

        .back-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background-color: #66bb6a;
            color: white;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }

        .back-btn:hover {
            background-color: #57a65e;
        }

        #message {
            margin-top: 15px;
            color: #388e3c;
            font-weight: bold;
            text-align: center;
        }

        .chart-wrap {
            margin: 30px auto;
            max-width: 650px;
            padding: 20px;
        }
    </style>
</head>

<body>
    <header>菴馴㍾險倬鹸</header>

    <div class="container">
        <label>莉頑律縺ｮ菴馴㍾・・g・・/label>
        <input type="number" id="weightInput" step="0.1" placeholder="萓具ｼ・2.5" />

        <button class="save-btn" id="saveBtn">險倬鹸縺吶ｋ</button>
        <button class="back-btn" onclick="location.href='home.html'">繝帙・繝縺ｸ謌ｻ繧・/button>

        <div id="message"></div>
    </div>

    <div class="chart-wrap">
        <canvas id="weightChart"></canvas>
    </div>

    <script defer>
        document.addEventListener("DOMContentLoaded", () => {

            // 縺薙％繧剃ｿｮ豁｣・域怙驥崎ｦ・ｼ・
            const login_id = localStorage.getItem("login_id");

            if (!login_id) {
                alert("繝ｭ繧ｰ繧､繝ｳ諠・ｱ縺後≠繧翫∪縺帙ｓ縲ゅΟ繧ｰ繧､繝ｳ縺励※縺上□縺輔＞縲・);
                location.href = "login.html";
                return;
            }

            const weightInput = document.getElementById("weightInput");
            const saveBtn = document.getElementById("saveBtn");
            const message = document.getElementById("message");
            const ctx = document.getElementById("weightChart").getContext("2d");
            let chart = null;

            async function loadWeightData() {
                try {
                    const res = await fetch(`/api/weights/${login_id}`);
                    const data = await res.json();

                    const labels = data.map(d => String(d.record_date).split("T")[0]);
                    const weights = data.map(d => d.weight);

                    drawChart(labels, weights);
                } catch (err) {
                    console.error("隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:", err);
                }
            }

            function drawChart(labels, data) {
                if (chart) chart.destroy();

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: '菴馴㍾縺ｮ謗ｨ遘ｻ・・g・・,
                            data,
                            borderColor: "#4caf50",
                            borderWidth: 3,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: "#66bb6a",
                            pointBorderColor: "#388e3c",
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            saveBtn.addEventListener("click", async () => {
                const weight = weightInput.value;
                if (!weight) return alert("菴馴㍾繧貞・蜉帙＠縺ｦ縺上□縺輔＞");

                try {
                    const res = await fetch("/api/weight", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ login_id, weight: Number(weight) })
                    });

                    if (res.ok) {
                        message.textContent = "菴馴㍾繧定ｨ倬鹸縺励∪縺励◆・・;
                        weightInput.value = "";
                        loadWeightData();
                    } else {
                        message.textContent = "菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・;
                    }
                } catch (err) {
                    console.error(err);
                    message.textContent = "菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆縲・;
                }
            });

            loadWeightData();
        });
    </script>
</body>

</html>
